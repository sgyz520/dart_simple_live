name: Build and Release BHTikTok Unified

on:
  workflow_dispatch:
    inputs:
      bhtiktok_version:
        description: "The version of BHTikTok Unified"
        default: "25.9.10"
        required: true
        type: string
      decrypted_tiktok_url:
        description: "The direct URL to the decrypted TikTok ipa"
        default: ""
        required: false
        type: string
      tiktok_version:
        description: "The version of TikTok"
        default: ""
        required: false
        type: string
      bundle_id:
        description: "Modify the bundle ID. Not recommended"
        default: "com.zhiliaoapp.musically"
        required: false
        type: string
      app_name:
        description: "Modify the name of the app on the Home Screen. Not recommended"
        default: "TikTok"
        required: false
        type: string
      create_release:
        description: "Create a draft release"
        default: true
        required: false
        type: boolean
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  build:
    name: Build BHTikTok Unified
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          path: main
          submodules: recursive

      - name: Install Dependencies
        run: |
          brew install ldid dpkg make subversion
          echo "$(brew --prefix make)/libexec/gnubin" >> $GITHUB_PATH

      - name: Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          ref: master
          path: theos
          submodules: recursive

      - name: Cache iOS SDK
        id: SDK
        uses: actions/cache@v4
        env:
          cache-name: iOS-15.5-SDK
        with:
          path: theos/sdks/
          key: ${{ env.cache-name }}

      - name: Download iOS 15.5 SDK
        if: steps.SDK.outputs.cache-hit != 'true'
        run: |
          curl -L -o iPhoneOS15.5.sdk.tar.gz https://github.com/chrisharper22/sdks/archive/refs/heads/main.tar.gz
          tar -xzf iPhoneOS15.5.sdk.tar.gz
          mv sdks-main/iPhoneOS15.5.sdk $THEOS/sdks/
          rm -rf sdks-main iPhoneOS15.5.sdk.tar.gz
        env:
          THEOS: ${{ github.workspace }}/theos

      - name: Setup Theos Jailed
        uses: actions/checkout@v4
        with:
          repository: qnblackcat/theos-jailed
          ref: master
          path: theos-jailed
          submodules: recursive

      - name: Install Theos Jailed
        run: |
          ./theos-jailed/install
        env:
          THEOS: ${{ github.workspace }}/theos

      - name: Build Tweak Package
        id: build_package
        run: |
          cd ${{ github.workspace }}/main
          
          # æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
          sed -i '' "s/Version: .*/Version: ${{ env.BHTIKTOK_VERSION }}/g" control
          
          # æ„å»ºåŒ…
          make package FINALPACKAGE=1
          
          # é‡å‘½ååŒ…æ–‡ä»¶
          PACKAGE_NAME="BHTikTokUnified_${{ env.BHTIKTOK_VERSION }}.deb"
          mv "packages/$(ls -t packages | head -n1)" "packages/$PACKAGE_NAME"
          
          echo "package=$PACKAGE_NAME" >>$GITHUB_OUTPUT
          echo -e "==> \033[1mSHASUM256: $(shasum -a 256 packages/*.deb | cut -f1 -d' ')\033[0m"
          echo -e "==> \033[1mPackage: $PACKAGE_NAME\033[0m"
        env:
          THEOS: ${{ github.workspace }}/theos
          BHTIKTOK_VERSION: ${{ inputs.bhtiktok_version || '25.9.10' }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: BHTikTokUnified_${{ inputs.bhtiktok_version || '25.9.10' }}
          path: |
            ${{ github.workspace }}/main/packages/*.deb
          if-no-files-found: error

      - name: Create Release
        id: create_release
        if: ${{ inputs.create_release == true || startsWith(github.ref, 'refs/tags/') }}
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ format('v{0}-({1})', inputs.bhtiktok_version || '25.9.10', github.run_number) }}
          name: ${{ format('BHTikTok Unified v{0}', inputs.bhtiktok_version || '25.9.10') }}
          body: |
            ## ğŸ‰ BHTikTok Unified Release
            
            ### ğŸ“± ç‰ˆæœ¬ä¿¡æ¯ | Version Info
            - **BHTikTok Unified**: v${{ inputs.bhtiktok_version || '25.9.10' }}
            - **æ„å»ºå· | Build**: #${{ github.run_number }}
            - **æäº¤ | Commit**: ${{ github.sha }}
            
            ### ğŸš€ æ–°åŠŸèƒ½ | New Features
            - å®Œæ•´çš„åŠŸèƒ½å®ç°ä¸å¤šè¯­è¨€æ”¯æŒ
            - æ”¯æŒ12ç§è¯­è¨€çš„æœ¬åœ°åŒ–
            - ç°ä»£åŒ–çš„è®¾ç½®ç•Œé¢
            - å¢å¼ºçš„ä¸‹è½½åŠŸèƒ½
            - æ”¹è¿›çš„å®‰å…¨æ€§å’Œéšç§ä¿æŠ¤
            
            ### ğŸ“¦ ä¸‹è½½ | Downloads
            - **DEBåŒ…**: é€‚ç”¨äºè¶Šç‹±è®¾å¤‡
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹ | Notes
            - éœ€è¦iOS 14.0æˆ–æ›´é«˜ç‰ˆæœ¬
            - DEBåŒ…éœ€è¦è¶Šç‹±ç¯å¢ƒ
            
            ### ğŸ”— ç›¸å…³é“¾æ¥ | Links
            - [ä½¿ç”¨è¯´æ˜](https://github.com/${{ github.repository }}/blob/main/README.md)
            - [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
            - [Telegramé¢‘é“](https://t.me/BHTikTokUnified)
          files: |
            main/packages/*.deb
          draft: ${{ inputs.create_release == true }}
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}

  test:
    name: Test Build
    runs-on: macos-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install Dependencies
        run: brew install ldid
        
      - name: Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          ref: master
          path: theos
          
      - name: Test Compilation
        run: |
          export THEOS=${{ github.workspace }}/theos
          make clean
          make
        env:
          THEOS: ${{ github.workspace }}/theos